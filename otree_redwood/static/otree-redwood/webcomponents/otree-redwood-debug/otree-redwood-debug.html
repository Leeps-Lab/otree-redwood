<link
	rel="import"
	href="/static/bower_components/polymer/polymer.html" />


<dom-module id="otree-redwood-debug">

	<template>
		<style>
			:host {
				display: block;
			}
		</style>
		<div id="chart"></div>
	</template>

	<script>
		Polymer({
			is: 'otree-redwood-debug',
			properties: {
				events: {
					type: Array,
					value: () => {
						return [];
					}
				}
			},
			ready() {
				let protocol = 'ws://';
				if (window.location.protocol === 'https:') {
					protocol = 'wss://';
				}
				const addr = (
					protocol +
					window.location.host +
					'/otree/redwood/debug/');
				this.socket = new ReconnectingWebSocket(addr, null, {
					timeoutInterval: 10000
				});
				this.socket.onerror = this.onError.bind(this);
				this.socket.onmessage = this.onMessage.bind(this);
				$.getJSON('/redwood-events/').done((events) => {
					this.set('events', events);
				});

				this.graph = Highcharts.chart({
					chart: {
						animation: true,
						renderTo: this.$.chart,
						width: this.offsetWidth,
						height: this.offsetHeight
					},
					title: { text: null },
					exporting: { enabled: false },
					tooltip: { enabled: false },
					legend: { enabled: false },
					credits: { enabled: false },
					xAxis: {
						type: 'datetime',
						dateTimeLabelFormats: {
							second: '%H:%M:%S'
						}
					},
					yAxis: {
						title: { text: undefined },
						min: 0,
						max: 1
					},
					plotOptions: {
						line: {marker: {enabled: false}},
						series: {
							states: {
								hover: {
									enabled: false,
								}
							}
						}
					},
					line: {
						marker: {
							enabled: false,
							states: {
								hover: { enabled: false },
								select: { enabled: false }
							}
						}
					},
					series: [{
						data: [],
					}]
				});

				window.requestAnimationFrame(this._update.bind(this));
			},
			onError(err) {
				console.error(err);
			},
			onMessage(message) {
				const event = JSON.parse(message.data);
				this.events.push(event);
			},
			_update() {
				const eventDataset = [];
				for (let i = 0; i < this.events.length; i++) {
					const e = this.events[i];
					if (e.channel == 'decisions') {
						eventDataset.push([e.timestamp, e.value]);
					}
				}
				this.graph.series[0].setData(eventDataset);
				window.requestAnimationFrame(this._update.bind(this));
			}
		});
	</script>

</dom-module>
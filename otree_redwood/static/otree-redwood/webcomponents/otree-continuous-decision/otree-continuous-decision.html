<link
	rel="import"
	href="/static/bower_components/polymer/polymer.html" />

<link
	rel="import" 
	href="/static/otree-redwood/webcomponents/otree-constants/otree-constants.html">
<link
    rel="import"
    href="/static/otree-redwood/webcomponents/otree-channel/otree-channel.html" />


<dom-module id="otree-continuous-decision">

	<template>
    	<otree-constants id="constants"></otree-constants>
    	<otree-channel
    		id="decisionsChannel"
    		channel="decisions"
    		on-event="_handleDecisionEvent">
	    </otree-channel>
    	<otree-channel
    		id="groupDecisionsChannel"
    		channel="group_decisions"
    		on-event="_handleGroupDecisionsEvent">
	    </otree-channel>
	</template>

	<script>
		Polymer({
			is: 'otree-continuous-decision',
			properties: {
				component: {
					type: String
				},
				groupDecisions: {
					type: Object,
					readonly: true,
					notify: true,
					observer: '_groupDecisionsChanged',
					value: () => { return {} }
				},
				myDecision: {
					type: Number,
					observer: '_myDecisionChanged',
					notify: true,
					value: 0.5
				},
				otherDecision: {
					type: Number,
					readonly: true,
					notify: true,
					computed: '_computeOtherDecision(groupDecisions.*)'
				}
			},
			_handleDecisionEvent(event) {
				console.log('_handleDecisionEvent');
				this.set(
					['groupDecisions', event.detail.participant_code],
					event.detail.payload);
			},
			_handleGroupDecisionsEvent(event) {
				console.log('_handleGroupDecisionsEvent');
				this.groupDecisions = event.detail.payload;
			},
			_computeOtherDecision(groupDecisions) {
				this.groupDecisions = this.groupDecisions || {};
				const pcode = this.$.constants.participantCode;

				// group decisions should have two entries maximum
				console.assert (Object.keys(this.groupDecisions).length <= 2, "too many players in group decisions");

				for (let key in this.groupDecisions) {
                    if (key != pcode) {
                    	return this.groupDecisions[key];
                    }
                }

                // if no key for the other player is found, just default to 0.5
                return 0.5;
			},
			_myDecisionChanged(newValue, oldValue) {
				if (isNaN(newValue)) {
					if (oldValue !== undefined)  {
						newValue = oldValue;
					} else {
						newValue = 0.5;
					}
				}
				console.log('_myDecisionChanged');
				this.$.decisionsChannel.send(this.myDecision);

				const pcode = this.$.constants.participantCode;
				this.set(['groupDecisions', pcode], this.myDecision);
			},
			_groupDecisionsChanged() {
				console.log('_groupDecisionsChanged');
				const pcode = this.$.constants.participantCode;
				this.myDecision = this.groupDecisions[pcode];
			}
		});
	</script>

</dom-module>
<link
	rel="import"
	href="/static/bower_components/polymer/polymer.html" />

<link
	rel="import" 
	href="/static/otree-redwood/webcomponents/otree-constants/otree-constants.html">

<dom-module id="otree-events">

	<template>
    	<otree-constants id="constants"></otree-constants>
	</template>

	<script>
		var socket = null;
		var listeners = [];

		function onError(error) {
			console.error(error);
		}

		function onOpen(event) {
			listeners.forEach(l => {
				l.onOpen('open');
			});
		}

		function onMessage(event) {
			listeners.forEach(l => {
				l.fire('event', event);
			});
		}

		Polymer({
			is: 'otree-events',
			ready() {
				if (socket === null) {
					socket = new WebSocket(
						'ws://' +
						window.location.host +
						'/otree/redwood' +
						'/session/' + this.$.constants.session +
						'/subsession/' + this.$.constants.subsession +
						'/round/' + this.$.constants.round +
						'/group/' + this.$.constants.group +
						'/participant/' + this.$.constants.participantCode +
						'/');
					socket.onerror = onError;
					socket.onopen = onOpen;
					socket.onmessage = onMessage;
				}
				this.pending = [];
				this.connected = false;
			},
			attached() {
				listeners.push(this);
			},
			detached() {
				listeners.splice(listeners.indexOf(this), 1);
			},
			onOpen() {
				this.connected = true;
				this.pending.forEach(msg => {
					socket.send(msg);
				});
			},
			send(channel, value) {
				const msg = JSON.stringify({
					'channel': channel,
					'payload': value
				});
				if (!this.connected) {
					this.pending.push(msg);
					return;
				}
				socket.send(msg);
			}
		});
	</script>

</dom-module>